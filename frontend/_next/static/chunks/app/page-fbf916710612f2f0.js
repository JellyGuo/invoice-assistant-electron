(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{80052:(e,t,a)=>{Promise.resolve().then(a.bind(a,92187))},92187:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>Z});var i=a(73365);a(61779),a(25712);var n=a(30495),r=a(20262),s=a(56524);class l extends n.Ay{async createChatIfNotExist(e){await this.chatHistories.get(e.id)||await this.chatHistories.add(e)}async upsertChat(e){await this.chatHistories.put({...e,updatedTime:e.updatedTime||new Date})}async getChatById(e){return this.chatHistories.get(e)}async deleteChat(e){await this.chatHistories.delete(e)}async getAllChats(){return(await this.chatHistories.orderBy("updatedTime").reverse().toArray()).map(e=>{let{messages:t,...a}=e;return a})}constructor(){super("ChatDatabase"),this.version(1).stores({chatHistories:"id, updatedTime"}),this.chatHistories.hook("creating",()=>{setTimeout(()=>(0,r.j)("all-chats"),0)}),this.chatHistories.hook("updating",()=>{setTimeout(()=>(0,r.j)("all-chats"),0)}),this.chatHistories.hook("deleting",()=>{setTimeout(()=>(0,r.j)("all-chats"),0)})}}let o=new l,d=async e=>await o.getChatById(e),c=e=>{let t=!!e,{data:a,error:i,isLoading:n}=(0,s.Ay)(t?["chat",e]:null,()=>d(e));return{chat:a,error:i,isLoading:n}},h=async()=>await o.getAllChats(),u=()=>{let{data:e,error:t,isLoading:a}=(0,s.Ay)("all-chats",h);return{chats:null!=e?e:[],error:t,isLoading:a}};var m=a(62838),x=a(63628),p=a(83266),g=a(1521);function f(e){let{type:t,name:a,initials:n,loading:r}=e;return"gen-ai"===t?(0,i.jsx)(m.A,{color:"gen-ai",iconName:"gen-ai",tooltipText:a,ariaLabel:a,loading:r}):(0,i.jsx)(m.A,{initials:n,tooltipText:a,ariaLabel:a})}let v=(0,g.forwardRef)(function(e,t){let{children:a}=e;return(0,i.jsx)("div",{style:{position:"relative",blockSize:"100%"},children:(0,i.jsx)("div",{style:{position:"absolute",inset:0,overflowY:"auto"},ref:t,"data-testid":"chat-scroll-container",children:a})})});async function A(e,t){let a=await fetch(e),i=await a.blob();return new File([i],t,{type:i.type})}function j(e){let{attachments:t}=e,[a,n]=g.useState([]);return g.useEffect(()=>{(async()=>{n(await Promise.all(t.map(e=>{let{url:t,name:a}=e;return A(t,a||"no-name")})))})()},[t]),(0,i.jsx)(x.A,{limit:3,readOnly:!0,showFileThumbnail:!0,onDismiss:()=>{},items:a.map(e=>({file:e})),alignment:"vertical",i18nStrings:{removeFileAriaLabel:e=>"Remove file ".concat(e+1),limitShowFewer:"Show fewer files",limitShowMore:"Show more files",errorIconAriaLabel:"Error",warningIconAriaLabel:"Warning"},showFileSize:!0})}p.A,a(22014);var y=a(68826),w=a(41554);a(18017),a(58613);var b=a(6204);a(42994).A;let S={user:{type:"user",name:""},assistant:{type:"gen-ai",name:"AI assistant"}};i.Fragment,new Date().toLocaleTimeString(),y.A,new Date().toLocaleTimeString();let C={removeFileAriaLabel:e=>"Remove file ".concat(e+1),limitShowFewer:"Show fewer files",limitShowMore:"Show more files",errorIconAriaLabel:"Error",warningIconAriaLabel:"Warning"};var N=a(31607),_=a(80630),T=a(23923);function k(e){let{data:t}=e,[a,n]=g.useState([]);return(0,i.jsx)(T.A,{items:t,trackBy:"name",columnDefinitions:[{id:"name",header:"File Name",cell:e=>e.name,isRowHeader:!0,maxWidth:200},{id:"tradeDate",header:"Trade Date",cell:e=>e.tradeDate||"-"},{id:"amount",header:"Amount (\xa5)",cell:e=>e.amount.toFixed(2)},{id:"kind",header:"Kind",cell:e=>e.kind},{id:"vendor",header:"Vendor",maxWidth:200,cell:e=>e.vendor}],expandableRows:{getItemChildren:e=>e.children,isItemExpandable:e=>e.children.length>0,expandedItems:a,onExpandableItemToggle:e=>{let{detail:a}=e;return n(e=>{let i=new Set(e.map(e=>e.name));return a.expanded?i.add(a.item.name):i.delete(a.item.name),Array.from(i).map(e=>t.find(t=>t.name===e)).filter(e=>void 0!==e)})}},header:(0,i.jsx)(_.A,{children:"Expense Invoices"}),empty:(0,i.jsx)(w.A,{textAlign:"center",color:"inherit",margin:{vertical:"xs"},children:(0,i.jsxs)(b.A,{size:"m",children:[(0,i.jsx)("b",{children:"No invoices found"}),(0,i.jsx)(N.A,{children:"Create invoice"})]})})})}var F=a(45634),I=a(85352),L=a(8076),D=a(9038);function E(e){let{messages:t,append:a,loading:n}=e;return(0,i.jsx)("div",{className:"messages",role:"region","aria-label":"Chat",children:t.map((e,r)=>{var s,l;let o=S[e.role],d=n&&r===t.length-1;return(0,i.jsx)(b.A,{size:"s",children:(0,i.jsxs)(F.A,{avatar:(0,i.jsx)(f,{...o,loading:d}),ariaLabel:"".concat(o.name),type:"user"===e.role?"outgoing":"incoming",actions:(0,i.jsx)("div",{children:e.experimental_attachments&&(0,i.jsx)(j,{attachments:e.experimental_attachments})}),children:[(0,i.jsxs)(b.A,{size:"s",children:[null===(s=e.parts)||void 0===s?void 0:s.map((t,a)=>{let{type:n}=t,r="message-".concat(e.id,"-part-").concat(a);if("reasoning"===n)return(0,i.jsx)(I.A,{defaultExpanded:!0,headerText:"THINKING",children:(0,i.jsx)(w.A,{variant:"pre",color:"text-status-inactive",className:"pre-wrap",children:t.reasoning})},r);if("text"===n){let{text:e}=t;return(0,i.jsx)(w.A,{variant:"pre",className:"pre-wrap",margin:{top:"n"},children:e},r)}}),(0,i.jsx)(L.A,{steps:null===(l=e.parts)||void 0===l?void 0:l.map(e=>{let{type:t}=e;if("tool-invocation"===t){let{toolInvocation:t}=e,{toolName:n,toolCallId:r,state:s,args:l}=t;if("call"===s||"partial-call"===s)return{status:"ask_user"===n?"info":"loading",header:(0,i.jsx)(D.A,{fixedWidth:!0,size:"large",header:n,content:(0,i.jsxs)(w.A,{variant:"p",margin:{top:"n"},children:["Arguments: ",JSON.stringify(l,null,2)]}),children:n},r)};if("result"===s){let{result:e}=t;return"confirm_invoice_merge_changes"===n?{status:"success",header:(0,i.jsx)(D.A,{fixedWidth:!0,size:"large",header:n,content:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(w.A,{variant:"p",margin:{top:"n"},children:["Arguments:"," ",JSON.stringify(l,null,2)]}),(0,i.jsxs)(w.A,{variant:"p",margin:{top:"n"},children:["Return:"," ",JSON.stringify(e,null,2)]})]}),children:n},r),details:(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(w.A,{padding:{top:"s",bottom:"s"},children:[(0,i.jsx)(k,{data:function(e){let t=[];for(let i of e)for(let e of i.filter(e=>e.type.toLowerCase().includes("invoice"))){var a;let n=i.filter(t=>t!==e).map(e=>{var t;return{name:e.invoice_name,expenseType:e.report_type,tradeDate:e.trade_date||e.date||"",amount:null!==(t=e.invoice_amount)&&void 0!==t?t:0,vendor:e.invoice_vendor||e.vendor||"",kind:e.type,children:[]}});t.push({name:e.invoice_name,expenseType:e.report_type,tradeDate:e.trade_date||"",amount:null!==(a=e.invoice_amount)&&void 0!==a?a:0,vendor:e.invoice_vendor||"",kind:e.type,children:n})}return t}(JSON.parse(e))}),(0,i.jsx)(w.A,{padding:{top:"s"},children:(0,i.jsx)(N.A,{variant:"primary",onClick:()=>{a({role:"user",content:"我确认"})},children:"我确认"})})]})})}:{status:"success",header:(0,i.jsx)(D.A,{fixedWidth:!0,size:"large",header:n,content:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(w.A,{variant:"p",margin:{top:"n"},children:["Arguments: ",JSON.stringify(l,null,2)]}),(0,i.jsxs)(w.A,{variant:"p",margin:{top:"n"},children:["Return: ",JSON.stringify(e,null,2)]})]}),children:n},r),details:e&&(0,i.jsx)(w.A,{variant:"pre",className:"scrollable-div",children:e})}}}}).filter(e=>!!e)})]}),(0,i.jsxs)(w.A,{variant:"pre",fontSize:"body-s",color:"text-status-inactive",textAlign:"left",children:["message id: ",e.id]})]})},e.id)})})}var H=a(59574),z=a(91606),O=a(71192),R=a(51041),W=a(85940),B=a(85991),J=a(42626),M=a(55739),P=a(20369),G=a(26278);function K(e){var t;let{id:a,actions:n,chat_api_url:r}=e,{chat:s,isLoading:l}=c(a),d=(0,g.useRef)(null),[h,u]=(0,g.useState)([]),[m,p]=(0,g.useState)(!0),f=(0,g.useRef)(null),{areFilesDragging:A}=(0,G.o)(),{messages:j,input:y,handleSubmit:S,handleInputChange:T,status:k,error:F,append:L,setMessages:D}=(0,H.Y_)({id:a,api:r,streamProtocol:"data",maxSteps:0,sendExtraMessageFields:!0,initialMessages:(null==s?void 0:s.messages)||[],onFinish:()=>{D(e=>((async function(){var t;if(!a)return console.warn("Chat ID is not defined, cannot upsert chat."),e;await o.upsertChat({id:a||"",title:(null===(t=e[0])||void 0===t?void 0:t.content)||"Untitled Chat",messages:e,updatedTime:new Date})})().catch(console.error),e))}}),K="ready"===k,Y=["submitted","streaming"].includes(k),$=null===(t=j[j.length-1])||void 0===t?void 0:t.content;return(0,g.useEffect)(()=>{setTimeout(()=>{d.current&&(d.current.scrollTop=d.current.scrollHeight)},0)},[$]),(0,g.useEffect)(()=>{F&&p(!0)},[F]),(0,i.jsxs)(O.A,{header:(0,i.jsx)(_.A,{variant:"h1",actions:n,description:"Chat id: ".concat(a),children:"Chat"}),fitHeight:!0,disableContentPaddings:!0,footer:(0,i.jsxs)(i.Fragment,{children:[Y&&(0,i.jsx)(z.Gm,{variant:"gen-ai-masked"}),(0,i.jsx)(b.A,{size:"m",direction:"horizontal",children:(0,i.jsx)(w.A,{margin:{top:"xs",bottom:"xs"},children:(0,i.jsx)(N.A,{onClick:()=>{L({role:"user",content:"帮我报销"},{experimental_attachments:U(h)}),u([])},children:"帮我报销"})})}),(0,i.jsx)(R.A,{ref:f,onChange:e=>{let{detail:t}=e;T({target:{value:t.value}})},onAction:()=>{S(void 0,{experimental_attachments:U(h)}),u([])},value:y,disabled:Y,actionButtonAriaLabel:K?"Send message button - suppressed":"Send message",actionButtonIconName:Y?"close":"send",placeholder:Y?"Send message button - suppressed":"Send message",autoFocus:!0,secondaryActions:(0,i.jsx)(w.A,{padding:{left:"xxs",top:"xs"},children:(0,i.jsx)(W.A,{ariaLabel:"Chat demo file input",variant:"icon",multiple:!0,value:h,onChange:e=>{let{detail:t}=e;return u(e=>[...e,...t.value])}})}),secondaryContent:A?(0,i.jsx)(B.A,{onChange:e=>{let{detail:t}=e;return u(e=>[...e,...t.value])},children:(0,i.jsxs)(b.A,{size:"xs",alignItems:"center",children:[(0,i.jsx)(J.A,{name:"upload"}),(0,i.jsx)(w.A,{children:"Drop files here"})]})}):h.length>0&&(0,i.jsx)(x.A,{items:h.map(e=>({file:e})),onDismiss:e=>{let{detail:t}=e;if(u(e=>e.filter((e,a)=>a!==t.fileIndex)),1===h.length){var a;null===(a=f.current)||void 0===a||a.focus()}},limit:3,alignment:"horizontal",showFileThumbnail:!0,i18nStrings:C})}),(0,i.jsxs)(w.A,{color:"text-body-secondary",margin:{top:"xs"},fontSize:"body-s",children:["status: ",k]})]}),children:[F&&m&&(0,i.jsx)(M.A,{type:"error",dismissible:!0,onDismiss:()=>p(!1),children:(0,i.jsx)(I.A,{variant:"inline",headerText:"".concat(F.name,": ").concat(F.message),children:F.stack})}),(0,i.jsx)(v,{ref:d,children:l?(0,i.jsx)(w.A,{textAlign:"center",padding:"l",children:(0,i.jsx)(P.A,{type:"loading",children:"Loading chat history..."})}):(0,i.jsx)(E,{messages:j,append:L,loading:Y})})]})}function U(e){let t=new DataTransfer;return e.forEach(e=>t.items.add(e)),t.files}var Y=a(7380),$=a(59660),V=a(97157),q=a.n(V);function Q(e){let{onNewChat:t,onSelectChatHistory:a}=e,[n,r]=(0,g.useState)(""),{chats:s,isLoading:l}=u();return(0,i.jsx)(w.A,{margin:{bottom:"l"},children:(0,i.jsxs)(b.A,{size:"l",children:[(0,i.jsx)(_.A,{children:"Menu"}),(0,i.jsx)(N.A,{fullWidth:!0,iconName:"add-plus",onClick:()=>{let e=(0,Y.$C)();t(e),r(e)},children:"New Chat"}),(0,i.jsx)(N.A,{fullWidth:!0,children:"Settings"}),(0,i.jsx)(_.A,{children:"History"}),l?(0,i.jsx)(w.A,{textAlign:"center",padding:"l",children:(0,i.jsx)(P.A,{type:"loading",children:"Loading..."})}):(0,i.jsx)($.A,{onChange:e=>{let{detail:t}=e,i=t.value;i&&(a(i),r(i))},value:n,columns:1,items:s.map(e=>({label:e.title||"Untitled Chat",value:e.id,description:q()(e.updatedTime).fromNow()}))})]})})}var X=a(30685);function Z(){let[e,t]=(0,g.useState)(!1),[a,n]=(0,g.useState)("");return(0,g.useEffect)(()=>{n((0,X.$C)())},[]),(0,i.jsxs)("div",{className:"flex h-screen",children:[(0,i.jsx)("aside",{className:"transition-all duration-300 p-4 ".concat(e?"w-16":"w-64"),children:(0,i.jsx)(Q,{onNewChat:e=>{n(e)},onSelectChatHistory:e=>{n(e)}})}),(0,i.jsx)("main",{className:"flex-1 bg-gray-100 p-6 flex flex-col overflow-hidden",children:(0,i.jsx)("div",{className:"flex flex-1 [&>*]:flex-1 overflow-y-auto p-4 no-tailwindcss-reset",children:(0,i.jsx)(K,{id:a,chat_api_url:"http://localhost:8123/api/v1/chat/stream"})})})]})}},61779:()=>{},25712:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[12,574,819,426,932,244,529,999,390,930,478,322,347,239,358],()=>t(80052)),_N_E=e.O()}]);